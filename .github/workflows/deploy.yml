name: ðŸš€ Deploy to Production

# DÃ©clencheur : seulement sur push vers main
on:
  push:
    branches: [main]
  workflow_dispatch:  # Permet de dÃ©clencher manuellement depuis GitHub

# Permissions
permissions:
  contents: read

jobs:
  # Job : VÃ©rification avant dÃ©ploiement (simplifiÃ©)
  verify:
    name: âœ… Verify Build
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: âœ… Quick Build Verification
        run: |
          echo "âœ… VÃ©rification rapide du build..."
          echo ""
          echo "Les builds frontend et backend sont vÃ©rifiÃ©s dans le workflow 'Build Check'."
          echo "On peut procÃ©der au dÃ©ploiement."

  # Job : DÃ©ploiement en production
  deploy:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: verify
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            frontend/package-lock.json
            backend/package-lock.json

      - name: ðŸ“¥ Install Frontend dependencies
        working-directory: ./frontend
        run: npm ci --legacy-peer-deps

      - name: ðŸ“¥ Install Backend dependencies
        working-directory: ./backend
        run: npm ci --legacy-peer-deps

      - name: ðŸ”§ Make scripts executable
        run: chmod +x scripts/*.sh

      - name: ðŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: ðŸš€ Deploy to production
        run: |
          DEPLOY_HOST=${{ secrets.DEPLOY_HOST }} \
          DEPLOY_PATH=${{ secrets.DEPLOY_PATH }} \
          ./scripts/deploy-prod.sh --skip-check
        env:
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
          VITE_API_URL: ${{ secrets.VITE_API_URL }}

      - name: ðŸ¥ Health Check
        run: |
          sleep 10
          curl -f https://www.reboulstore.com/health || echo "âš ï¸ Health check failed (may be normal if DNS not pointing)"
        continue-on-error: true

      - name: ðŸ“Š Deployment Summary
        if: always()
        run: |
          echo "## ðŸš€ DÃ©ploiement TerminÃ©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… DÃ©ploiement sur : ${{ secrets.DEPLOY_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… Date : $(date)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— Commit : ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

