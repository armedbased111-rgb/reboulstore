name: ğŸ” Build Check

# DÃ©clencheurs : Ã  chaque push et pull request
on:
  push:
    branches: ['*']  # Toutes les branches
  pull_request:
    branches: [main, develop]

# Permissions pour GitHub Actions
permissions:
  contents: read
  pull-requests: write

jobs:
  # Job : VÃ©rification Build Frontend
  build-frontend:
    name: ğŸ“¦ Build Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ğŸ“¥ Install dependencies
        working-directory: ./frontend
        run: npm ci --legacy-peer-deps

      - name: ğŸ” TypeScript check
        working-directory: ./frontend
        run: npx tsc -b --noEmit

      - name: ğŸ§¹ Lint
        working-directory: ./frontend
        run: npm run lint || true

      - name: ğŸ—ï¸ Build
        working-directory: ./frontend
        run: npm run build

      - name: ğŸ“Š Bundle size check
        working-directory: ./frontend
        run: |
          SIZE=$(du -sh dist | cut -f1)
          echo "ğŸ“¦ Bundle size: $SIZE"
          if [ "$(du -sm dist | cut -f1)" -gt 1000 ]; then
            echo "âš ï¸ Bundle size is large (>1GB)"
          fi

  # Job : VÃ©rification Build Backend
  build-backend:
    name: ğŸ“¦ Build Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: ğŸ“¥ Install dependencies
        working-directory: ./backend
        run: npm ci --legacy-peer-deps

      - name: ğŸ” TypeScript check
        working-directory: ./backend
        run: npx tsc --noEmit

      - name: ğŸ§¹ Lint
        working-directory: ./backend
        run: npm run lint || true

      - name: ğŸ—ï¸ Build
        working-directory: ./backend
        run: npm run build

  # Job : VÃ©rification globale (simplifiÃ© - sans script externe)
  check-build:
    name: âœ… Check Build Summary
    runs-on: ubuntu-latest
    needs: [build-frontend, build-backend]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âœ… Build Check Summary
        run: |
          echo "âœ… Build Check rÃ©ussi !"
          echo ""
          echo "RÃ©sultats :"
          echo "  - Frontend : âœ… Build rÃ©ussi"
          echo "  - Backend : âœ… Build rÃ©ussi"
          echo ""
          echo "Le code est prÃªt pour le dÃ©ploiement !"

  # Job : Commentaire sur Pull Request
  pr-comment:
    name: ğŸ’¬ PR Comment
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [build-frontend, build-backend, check-build]
    
    steps:
      - name: ğŸ’¬ Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ needs.build-frontend.result }}' === 'success' && 
                          '${{ needs.build-backend.result }}' === 'success' && 
                          '${{ needs.check-build.result }}' === 'success';
            
            const emoji = status ? 'âœ…' : 'âŒ';
            const message = status 
              ? 'âœ… **Build Check rÃ©ussi !** Le code est prÃªt Ã  Ãªtre mergÃ©.'
              : 'âŒ **Build Check Ã©chouÃ©.** Veuillez corriger les erreurs avant de merger.';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${emoji} ${message}`
            });

