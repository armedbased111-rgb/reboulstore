name: ğŸ” Build Check

# DÃ©clencheurs : Ã  chaque push et pull request
on:
  push:
    branches: ['*']  # Toutes les branches
  pull_request:
    branches: [main, develop]

# Permissions pour GitHub Actions
permissions:
  contents: read
  pull-requests: write

jobs:
  # Job : VÃ©rification Build Frontend
  build-frontend:
    name: ğŸ“¦ Build Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ğŸ“¥ Install dependencies
        working-directory: ./frontend
        run: npm ci --legacy-peer-deps

      - name: ğŸ” TypeScript check
        working-directory: ./frontend
        run: npx tsc -b --noEmit

      - name: ğŸ§¹ Lint
        working-directory: ./frontend
        run: npm run lint || true

      - name: ğŸ—ï¸ Build
        working-directory: ./frontend
        run: npm run build

      - name: ğŸ“Š Bundle size check
        working-directory: ./frontend
        run: |
          SIZE=$(du -sh dist | cut -f1)
          echo "ğŸ“¦ Bundle size: $SIZE"
          if [ "$(du -sm dist | cut -f1)" -gt 1000 ]; then
            echo "âš ï¸ Bundle size is large (>1GB)"
          fi

  # Job : VÃ©rification Build Backend
  build-backend:
    name: ğŸ“¦ Build Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: ğŸ“¥ Install dependencies
        working-directory: ./backend
        run: npm ci --legacy-peer-deps

      - name: ğŸ” TypeScript check
        working-directory: ./backend
        run: npm run build -- --noEmit

      - name: ğŸ§¹ Lint
        working-directory: ./backend
        run: npm run lint || true

      - name: ğŸ—ï¸ Build
        working-directory: ./backend
        run: npm run build

  # Job : VÃ©rification globale (utilise notre script)
  check-build:
    name: âœ… Check Build (Script)
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Make scripts executable
        run: chmod +x scripts/*.sh

      - name: âœ… Run check-build.sh
        run: ./scripts/check-build.sh --skip-audit
        env:
          # Variables d'environnement minimales pour le check
          DB_USERNAME: test
          DB_PASSWORD: test
          DB_DATABASE: test
          DB_HOST: localhost
          DB_PORT: 5432
          JWT_SECRET: test_secret_min_32_chars_long_for_validation
          STRIPE_SECRET_KEY: sk_test_test
          STRIPE_WEBHOOK_SECRET: whsec_test
          CLOUDINARY_CLOUD_NAME: test
          CLOUDINARY_API_KEY: test
          CLOUDINARY_API_SECRET: test
          FRONTEND_URL: http://localhost:3000
          VITE_API_URL: http://localhost:3001

  # Job : Commentaire sur Pull Request
  pr-comment:
    name: ğŸ’¬ PR Comment
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [build-frontend, build-backend, check-build]
    
    steps:
      - name: ğŸ’¬ Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ needs.build-frontend.result }}' === 'success' && 
                          '${{ needs.build-backend.result }}' === 'success' && 
                          '${{ needs.check-build.result }}' === 'success';
            
            const emoji = status ? 'âœ…' : 'âŒ';
            const message = status 
              ? 'âœ… **Build Check rÃ©ussi !** Le code est prÃªt Ã  Ãªtre mergÃ©.'
              : 'âŒ **Build Check Ã©chouÃ©.** Veuillez corriger les erreurs avant de merger.';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${emoji} ${message}`
            });

